<!DOCTYPE html>
<html lang="en">
<head>
    <title>Oxean SA | ISP Admin Terminal</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    
    <link rel="stylesheet" type="text/css" href="vendor/bootstrap/css/bootstrap.min.css">
    <link rel="stylesheet" type="text/css" href="fonts/font-awesome-4.7.0/css/font-awesome.min.css">
    <link rel="stylesheet" type="text/css" href="fonts/iconic/css/material-design-iconic-font.min.css">
    <link rel="stylesheet" type="text/css" href="css/util.css">
    <link rel="stylesheet" type="text/css" href="css/main.css">

    <style>
        /* Exact layout logic from your index.html */
        html, body { overflow: hidden; height: 100vh; width: 100vw; font-family: 'Montserrat-Regular', sans-serif; background-color: #000; }

        .main-container {
            height: 100vh;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            background: radial-gradient(circle at center, #111 0%, #000 100%);
            padding: 20px;
        }

        /* The "Texture" and "Style" from your stat-cards */
        .dash-content {
            width: 100%;
            max-width: 1200px;
            height: 85vh;
            overflow-y: auto;
            padding-right: 10px;
        }

        .admin-card {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
            backdrop-filter: blur(10px);
        }

        .stat-label { color: rgba(255,255,255,0.5); font-size: 11px; text-transform: uppercase; letter-spacing: 2px; }
        .stat-value { color: #fff; font-family: 'Montserrat-SemiBold'; font-size: 28px; }

        /* Custom Scrollbar to match the tech theme */
        .dash-content::-webkit-scrollbar { width: 4px; }
        .dash-content::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.2); border-radius: 10px; }

        #login-overlay {
            position: fixed; inset: 0; background: #000; z-index: 9999;
            display: flex; align-items: center; justify-content: center;
        }

        .input-terminal {
            background: transparent;
            border-bottom: 1px solid rgba(255,255,255,0.2);
            color: #fff;
            text-align: center;
            font-family: Montserrat-Regular;
            padding: 10px;
            width: 100%;
            margin-bottom: 20px;
        }
    </style>
</head>
<body>

    <div id="login-overlay">
        <div class="text-center animate__animated animate__fadeIn" style="width: 300px;">
            <span class="stat-label">System Authentication</span>
            <h2 class="text-white Montserrat-SemiBold m-b-30 m-t-10">CORE ACCESS</h2>
            <input type="password" id="admin_password" class="input-terminal" placeholder="ENTER TOKEN">
            <button onclick="attemptLogin()" class="flex-c-m size2 s2-txt1 btn-blue p-lr-15 trans-04 rounded-pill w-full">
                AUTHORIZE
            </button>
            <p id="login-error" class="text-danger fs-12 m-t-20" style="display:none;">ACCESS DENIED</p>
        </div>
    </div>

    <div class="main-container">
        <div class="dash-content" id="dashboard-content" style="display:none;">
            
            <div class="d-flex justify-content-between align-items-end m-b-40">
                <div>
                    <span class="stat-label">Network Operations Center</span>
                    <h2 class="text-white Montserrat-SemiBold fs-30">ASHER-LINK ADMIN</h2>
                </div>
                <div class="text-right">
                    <button onclick="logout()" class="text-white fs-12 Montserrat-Regular op-05 trans-04 hov-op-1">TERMINATE SESSION</button>
                </div>
            </div>

            <div class="row">
                <div class="col-md-3">
                    <div class="admin-card">
                        <p class="stat-label">Net Revenue</p>
                        <p class="stat-value" id="total-revenue">R 0.00</p>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="admin-card">
                        <p class="stat-label">Active Nodes</p>
                        <p class="stat-value">148/150</p>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="admin-card">
                        <p class="stat-label">Global Traffic</p>
                        <div style="height: 40px;">
                             <canvas id="miniTrafficChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <div class="row m-t-20">
                <div class="col-md-8">
                    <div class="admin-card">
                        <p class="stat-label m-b-20">Deployment: Active Campaigns</p>
                        <div id="ad-list" class="row">
                            </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="admin-card">
                        <p class="stat-label m-b-20">Revenue Distribution</p>
                        <canvas id="revenueChart"></canvas>
                    </div>
                </div>
            </div>

            <div class="row m-t-20">
                <div class="col-md-6">
                    <div class="admin-card">
                        <p class="stat-label m-b-15">Package Configuration</p>
                        <div id="bundle-list"></div>
                        <button class="m-t-20 btn-blue fs-12 p-all-10 rounded-pill w-full">ADD NEW BUNDLE</button>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="admin-card">
                        <p class="stat-label m-b-15">Token Generation</p>
                        <form id="tokenForm">
                            <input type="text" id="token_pin" class="input-terminal fs-13" placeholder="TOKEN PIN">
                            <input type="number" id="token_amount" class="input-terminal fs-13" placeholder="VALUE (R)">
                            <button type="submit" class="btn-blue fs-12 p-all-10 rounded-pill w-full">GENERATE</button>
                        </form>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <script src="vendor/jquery/jquery-3.2.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        const API_BASE = "https://api.oxeansa.co.za/asherlink/admin";
        const SYSTEM_API = "https://api.oxeansa.co.za/asherlink/system";
        const HOTSPOT_API = "https://api.oxeansa.co.za/asherlink/hotspot";
        let adminToken = sessionStorage.getItem('adminToken');
        let revenueChart;

        // AUTHENTICATION LOGIC
        async function attemptLogin() {
            const password = document.getElementById('admin_password').value;
            try {
                const res = await fetch(`${API_BASE}/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ password })
                });
                const data = await res.json();
                if (res.ok && data.token) {
                    sessionStorage.setItem('adminToken', data.token);
                    adminToken = data.token;
                    showDashboard();
                } else {
                    $('#login-error').fadeIn();
                }
            } catch (err) { alert("Core API Connectivity Error"); }
        }

        function showDashboard() {
            $('#login-overlay').fadeOut();
            $('#dashboard-content').show();
            loadDashboard();
        }

        // DYNAMIC SYNC
        async function loadDashboard() {
            try {
                const [adsRes, summaryRes, bundlesRes] = await Promise.all([
                    fetch(`${SYSTEM_API}/ads/active`, { headers: { 'X-Admin-Token': adminToken } }),
                    fetch(`${API_BASE}/analytics/summary`, { headers: { 'X-Admin-Token': adminToken } }),
                    fetch(`${HOTSPOT_API}/bundles`)
                ]);

                const ads = await adsRes.json();
                const summary = await summaryRes.json();
                const bundles = await bundlesRes.json();

                $('#total-revenue').text(`R ${Number(summary.total_revenue || 0).toLocaleString()}`);
                
                renderAds(ads);
                renderBundles(bundles);
                updateCharts(ads);
            } catch (err) { 
                console.error(err); 
                if(err.message === 'Unauthorized') logout();
            }
        }

        function renderAds(ads) {
            $('#ad-list').html(ads.map(ad => `
                <div class="col-md-6 m-b-15">
                    <div style="background:rgba(255,255,255,0.03); border-radius:10px; padding:15px; border:1px solid rgba(255,255,255,0.05)">
                        <div class="d-flex justify-content-between align-items-center">
                            <span class="Montserrat-SemiBold text-white fs-13">${ad.ad_id}</span>
                            <span class="fs-11" style="color:${ad.active ? '#00ff88' : '#ff3366'}">${ad.active ? 'ACTIVE' : 'PAUSED'}</span>
                        </div>
                        <p class="stat-label m-t-10">Earnings: R ${((ad.impressions/1000)*5).toFixed(2)}</p>
                    </div>
                </div>
            `).join(''));
        }

        function renderBundles(bundles) {
            $('#bundle-list').html(bundles.map(b => `
                <div class="d-flex justify-content-between p-v-10 border-b-white-01">
                    <span class="text-white fs-12">${b.activePeriod} - ${b.bandwidth}</span>
                    <span class="text-white Montserrat-SemiBold fs-12">R${b.price}</span>
                </div>
            `).join(''));
        }

        function updateCharts(ads) {
            const ctx = document.getElementById('revenueChart').getContext('2d');
            if (revenueChart) revenueChart.destroy();
            revenueChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ads.map(a => a.ad_id),
                    datasets: [{
                        data: ads.map(a => a.impressions),
                        backgroundColor: ['#0061ff', '#60a5fa', '#3b82f6', '#1d4ed8'],
                        borderWidth: 0
                    }]
                },
                options: { cutout: '80%', plugins: { legend: { display: false } } }
            });
        }

        function logout() { sessionStorage.clear(); location.reload(); }
        
        $(document).ready(() => { 
            if (adminToken) showDashboard(); 
        });
    </script>
</body>
</html>
