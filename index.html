<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Asher-Link | Core Admin</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --primary: #2563eb;
            --dark: #0f172a;
            --bg: #f8fafc;
            --success: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
        }
        body {
            background-color: var(--bg);
            font-family: 'Inter', sans-serif;
            color: var(--dark);
        }
        .glass-card {
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 12px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        .nav-custom {
            background: var(--dark);
            padding: 1rem 0;
        }
        .ad-img {
            height: 140px;
            object-fit: cover;
        }
        .btn-primary {
            background: var(--primary);
            border: none;
        }
        .btn-primary:hover {
            background: #1d4ed8;
        }
        #login-overlay {
            position: fixed;
            inset: 0;
            background: var(--bg);
            z-index: 10000;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .section-title {
            border-left: 4px solid var(--primary);
            padding-left: 15px;
            font-weight: 700;
            margin-bottom: 20px;
        }
        .badge-active {
            background-color: var(--success);
            color: white;
        }
        .badge-inactive {
            background-color: var(--danger);
            color: white;
        }
        .progress-bar {
            background-color: var(--primary);
        }
        .form-check-input:checked {
            background-color: var(--primary);
            border-color: var(--primary);
        }
        .text-success {
            color: var(--success) !important;
        }
        .text-danger {
            color: var(--danger) !important;
        }
        .text-warning {
            color: var(--warning) !important;
        }
    </style>
</head>
<body>

<div id="login-overlay">
    <div class="glass-card p-5 text-center" style="width: 400px;">
        <i class="bi bi-cpu-fill text-primary fs-1 mb-3"></i>
        <h4 class="fw-bold">Core Access</h4>
        <input type="password" id="admin_password" class="form-control my-3 text-center" placeholder="Admin Token">
        <div id="login-error" class="text-danger small mb-2" style="display: none;">Invalid credentials</div>
        <button onclick="attemptLogin()" class="btn btn-primary w-100">Unlock System</button>
    </div>
</div>

<div id="dashboard-content" style="display:none;">
    <nav class="nav-custom mb-4 shadow">
        <div class="container d-flex justify-content-between align-items-center">
            <span class="navbar-brand text-white fw-bold"><i class="bi bi-broadcast me-2"></i>ASHER-LINK ADMIN</span>
            <div class="d-flex gap-2">
                <button onclick="downloadReport()" class="btn btn-sm btn-outline-light"><i class="bi bi-file-pdf me-1"></i>Report</button>
                <button onclick="logout()" class="btn btn-sm btn-danger"><i class="bi bi-power me-1"></i>Logout</button>
            </div>
        </div>
    </nav>

    <div class="container pb-5">

        <h5 class="section-title">ADVERTISING INFRASTRUCTURE</h5>
        <div class="row g-4 mb-5">
            <div class="col-lg-4">
                <div class="glass-card p-4 bg-dark text-white h-100">
                    <small class="text-uppercase opacity-50">Est. Revenue</small>
                    <h2 class="display-6 fw-bold" id="total-revenue">R 0.00</h2>
                    <canvas id="performanceChart" class="mt-3" height="150"></canvas>
                </div>
            </div>
            <div class="col-lg-8">
                <div class="glass-card p-4">
                    <h6 class="fw-bold mb-3">Deploy New Ad Campaign</h6>
                    <form id="uploadForm">
                        <div class="row g-2">
                            <div class="col-md-4">
                                <input type="text" id="new_ad_id" class="form-control" placeholder="Client Name" required>
                            </div>
                            <div class="col-md-4">
                                <input type="url" id="new_target_url" class="form-control" placeholder="Target URL">
                            </div>
                            <div class="col-md-4">
                                <input type="file" id="new_file" class="form-control" accept="image/*" required>
                            </div>
                            <div class="col-md-3">
                                <input type="number" id="new_total_limit" class="form-control" placeholder="Total Limit" min="1">
                            </div>
                            <div class="col-md-3">
                                <input type="number" id="new_daily_limit" class="form-control" placeholder="Daily Limit" min="1">
                            </div>
                            <div class="col-md-3">
                                <input type="number" id="new_cpm_rate" class="form-control" placeholder="CPM Rate (R)" step="0.01" min="0.01" value="50.00">
                            </div>
                            <div class="col-md-3">
                                <button type="submit" class="btn btn-primary w-100">Upload Asset</button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
        <div id="ad-list" class="row g-3 mb-5"></div>

        <hr class="my-5">

        <h5 class="section-title">UNCAPPED WIFI PACKAGES</h5>
        <div class="glass-card p-4 mb-4">
            <h6 class="fw-bold mb-3">Create Package</h6>
            <form id="bundleForm">
                <div class="row g-3">
                    <div class="col-md-3">
                        <label class="small fw-bold">Active Period</label>
                        <input type="text" id="pkg_period" class="form-control" placeholder="e.g. 1 Hour / 24 Hours" required>
                    </div>
                    <div class="col-md-2">
                        <label class="small fw-bold">Price (ZAR)</label>
                        <input type="number" id="pkg_price" class="form-control" placeholder="0.00" step="0.01" required>
                    </div>
                    <div class="col-md-2">
                        <label class="small fw-bold">Bandwidth</label>
                        <input type="text" id="pkg_speed" class="form-control" placeholder="e.g. 5Mbps" required>
                    </div>
                    <div class="col-md-2">
                        <label class="small fw-bold">Quota Status</label>
                        <input type="text" id="pkg_quota" class="form-control" value="Uncapped" readonly>
                    </div>
                    <div class="col-md-3 d-flex align-items-end">
                        <div class="form-check form-switch mb-2 me-3">
                            <input class="form-check-input" type="checkbox" id="pkg_voucher" checked>
                            <label class="form-check-label small">Accept 1Voucher</label>
                        </div>
                        <button type="submit" class="btn btn-success w-100">Save Package</button>
                    </div>
                </div>
            </form>
        </div>

        <div class="row g-3" id="bundle-list"></div>

        <hr class="my-5">

        <h5 class="section-title">SYSTEM ANALYTICS</h5>
        <div class="row g-4 mb-5">
            <div class="col-lg-6">
                <div class="glass-card p-4">
                    <h6 class="fw-bold mb-3">Revenue Analytics</h6>
                    <canvas id="revenueChart" height="200"></canvas>
                </div>
            </div>
            <div class="col-lg-6">
                <div class="glass-card p-4">
                    <h6 class="fw-bold mb-3">Package Performance</h6>
                    <canvas id="packageChart" height="200"></canvas>
                </div>
            </div>
        </div>

        <h5 class="section-title">SYSTEM CONTROLS</h5>
        <div class="row g-4">
            <div class="col-lg-4">
                <div class="glass-card p-4 text-center">
                    <i class="bi bi-arrow-clockwise text-primary fs-1 mb-3"></i>
                    <h6 class="fw-bold">Refresh Data</h6>
                    <button onclick="loadDashboard()" class="btn btn-outline-primary w-100">Sync Now</button>
                </div>
            </div>
            <div class="col-lg-4">
                <div class="glass-card p-4 text-center">
                    <i class="bi bi-gear text-warning fs-1 mb-3"></i>
                    <h6 class="fw-bold">System Health</h6>
                    <button onclick="checkSystemHealth()" class="btn btn-outline-warning w-100">Check Status</button>
                </div>
            </div>
            <div class="col-lg-4">
                <div class="glass-card p-4 text-center">
                    <i class="bi bi-database text-success fs-1 mb-3"></i>
                    <h6 class="fw-bold">Database Backup</h6>
                    <button onclick="createBackup()" class="btn btn-outline-success w-100">Backup Now</button>
                </div>
            </div>
        </div>

    </div>
</div>

<script>
    const API_BASE = "https://api.oxeansa.co.za/asherlink/admin";
    const HOTSPOT_API = "https://api.oxeansa.co.za/asherlink/hotspot";
    const SYSTEM_API = "https://api.oxeansa.co.za/asherlink/system";
    const DEFAULT_CPM = 5.00;
    let adminToken = sessionStorage.getItem('adminToken');
    let performanceChart, revenueChart, packageChart;

    if (adminToken) showDashboard();

    async function attemptLogin() {
        const password = document.getElementById('admin_password').value;
        try {
            const res = await fetch(`${API_BASE}/login`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ password: password })
            });
            const data = await res.json();
            if (res.ok && data.token) {
                sessionStorage.setItem('adminToken', data.token);
                adminToken = data.token;
                showDashboard();
            } else {
                document.getElementById('login-error').style.display = 'block';
            }
        } catch (err) {
            alert("Core API Connectivity Error");
            console.error(err);
        }
    }

    function showDashboard() {
        document.getElementById('login-overlay').style.display = 'none';
        document.getElementById('dashboard-content').style.display = 'block';
        loadDashboard();
    }

    function logout() {
        sessionStorage.clear();
        location.reload();
    }

    async function loadDashboard() {
        try {
            // Load ads data
            const adsRes = await fetch(`${SYSTEM_API}/ads/active`, {
                headers: { 'X-Admin-Token': adminToken }
            });
            if (adsRes.status === 401) throw new Error('Unauthorized');
            const ads = await adsRes.json();

            // Load bundles data
            const bundlesRes = await fetch(`${HOTSPOT_API}/bundles`);
            const bundles = await bundlesRes.json();

            renderAds(ads);
            renderBundles(bundles);
            updateCharts(ads, bundles);
            calculateGlobalRevenue(ads);
        } catch (err) {
            console.error('Dashboard load error:', err);
            if (err.message === 'Unauthorized') logout();
        }
    }

    function renderAds(ads) {
        const container = document.getElementById('ad-list');
        container.innerHTML = '';
        ads.forEach(ad => {
            const earnings = (ad.impressions / 1000) * (ad.cpm_rate || DEFAULT_CPM);
            const progress = ad.total_limit ? (ad.impressions / ad.total_limit) * 100 : 0;

            container.innerHTML += `
                <div class="col-xl-4 col-md-6">
                    <div class="glass-card h-100 overflow-hidden">
                        <img src="${ad.image_url}" class="ad-img w-100" onerror="this.src='https://placehold.co/600x400/0f172a/FFF?text=Asset+Offline'">
                        <div class="p-4">
                            <div class="d-flex justify-content-between align-items-start mb-3">
                                <div>
                                    <h6 class="fw-bold mb-0">${ad.ad_id}</h6>
                                    <span class="badge ${ad.active ? 'badge-active' : 'badge-inactive'} mt-1">
                                        ${ad.active ? 'Operational' : 'Paused'}
                                    </span>
                                </div>
                                <h5 class="text-success fw-bold">R ${earnings.toFixed(2)}</h5>
                            </div>
                            <div class="row g-2 mb-3">
                                <div class="col-6">
                                    <div class="p-2 bg-light rounded text-center small">
                                        <div class="text-secondary">Views</div>
                                        <div class="fw-bold">${ad.impressions.toLocaleString()}</div>
                                    </div>
                                </div>
                                <div class="col-6">
                                    <div class="p-2 bg-light rounded text-center small">
                                        <div class="text-secondary">Daily</div>
                                        <div class="fw-bold">${ad.daily_count || 0}/${ad.daily_limit || 'âˆž'}</div>
                                    </div>
                                </div>
                            </div>
                            <div class="mb-4">
                                <div class="d-flex justify-content-between small text-secondary mb-1">
                                    <span>Quota Progress</span>
                                    <span>${progress.toFixed(0)}%</span>
                                </div>
                                <div class="progress">
                                    <div class="progress-bar" style="width: ${progress}%"></div>
                                </div>
                            </div>
                            <div class="d-flex justify-content-between align-items-center">
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" ${ad.active ? 'checked' : ''} onchange="toggleAd('${ad._id}', this.checked)">
                                    <label class="form-check-label small text-secondary">Active Status</label>
                                </div>
                                <button class="btn btn-sm btn-outline-danger border-0" onclick="deleteAd('${ad._id}')">
                                    <i class="bi bi-trash3"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>`;
        });
    }

    function renderBundles(bundles) {
        const container = document.getElementById('bundle-list');
        container.innerHTML = '';

        bundles.forEach(pkg => {
            container.innerHTML += `
                <div class="col-md-3">
                    <div class="glass-card p-3 border-top border-primary border-4">
                        <h5 class="fw-bold mb-1">${pkg.activePeriod}</h5>
                        <div class="text-primary fw-bold fs-4">R ${pkg.price.toFixed(2)}</div>
                        <div class="small text-muted mb-3">
                            Speed: ${pkg.bandwidth} <br>
                            Quota: ${pkg.quota} <br>
                            Voucher: ${pkg.isVoucherAccepted ? 'Yes' : 'No'}
                        </div>
                        <button onclick="deleteBundle('${pkg._id}')" class="btn btn-sm btn-light w-100">
                            <i class="bi bi-trash3 me-1"></i>Remove
                        </button>
                    </div>
                </div>`;
        });
    }

    function updateCharts(ads, bundles) {
        updatePerformanceChart(ads);
        updateRevenueChart(ads);
        updatePackageChart(bundles);
    }

    function updatePerformanceChart(ads) {
        const ctx = document.getElementById('performanceChart').getContext('2d');
        if (performanceChart) performanceChart.destroy();
        performanceChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: ads.map(a => a.ad_id),
                datasets: [{
                    label: 'Lifetime Impressions',
                    data: ads.map(a => a.impressions),
                    backgroundColor: '#2563eb',
                    borderRadius: 6
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { display: false } },
                scales: { y: { grid: { display: false } } }
            }
        });
    }

    function updateRevenueChart(ads) {
        const ctx = document.getElementById('revenueChart').getContext('2d');
        if (revenueChart) revenueChart.destroy();

        const revenueData = ads.map(ad => (ad.impressions / 1000) * (ad.cpm_rate || DEFAULT_CPM));

        revenueChart = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: ads.map(a => a.ad_id),
                datasets: [{
                    data: revenueData,
                    backgroundColor: ['#2563eb', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6', '#06b6d4']
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { position: 'bottom' }
                }
            }
        });
    }

    function updatePackageChart(bundles) {
        const ctx = document.getElementById('packageChart').getContext('2d');
        if (packageChart) packageChart.destroy();

        packageChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: bundles.map(b => b.activePeriod),
                datasets: [{
                    label: 'Package Prices',
                    data: bundles.map(b => b.price),
                    backgroundColor: '#10b981',
                    borderRadius: 6
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { display: false } },
                scales: { y: { grid: { display: false } } }
            }
        });
    }

    function calculateGlobalRevenue(ads) {
        const total = ads.reduce((sum, ad) => sum + ((ad.impressions / 1000) * (ad.cpm_rate || DEFAULT_CPM)), 0);
        document.getElementById('total-revenue').innerText = `R ${total.toLocaleString(undefined, {minimumFractionDigits: 2})}`;
    }

    // --- API Handlers ---
    async function toggleAd(id, status) {
        try {
            await fetch(`${API_BASE}/ads/manage/${id}`, {
                method: 'PATCH',
                headers: {
                    'Content-Type': 'application/json',
                    'X-Admin-Token': adminToken
                },
                body: JSON.stringify({ active: status })
            });
            loadDashboard();
        } catch (err) {
            console.error('Toggle ad error:', err);
            alert('Failed to update ad status');
        }
    }

    async function deleteAd(id) {
        if (!confirm("Confirm removal of this campaign from the core network?")) return;
        try {
            await fetch(`${API_BASE}/ads/manage/${id}`, {
                method: 'DELETE',
                headers: { 'X-Admin-Token': adminToken }
            });
            loadDashboard();
        } catch (err) {
            console.error('Delete ad error:', err);
            alert('Failed to delete ad');
        }
    }

    async function deleteBundle(id) {
        if (!confirm("Delete this package?")) return;
        try {
            await fetch(`${API_BASE}/bundles/${id}`, {
                method: 'DELETE',
                headers: { 'X-Admin-Token': adminToken }
            });
            loadDashboard();
        } catch (err) {
            console.error('Delete bundle error:', err);
            alert('Failed to delete package');
        }
    }

    // --- Form Handlers ---
    document.getElementById('uploadForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const formData = new FormData();
        formData.append('ad_id', document.getElementById('new_ad_id').value);
        formData.append('target_url', document.getElementById('new_target_url').value);
        formData.append('total_limit', document.getElementById('new_total_limit').value);
        formData.append('daily_limit', document.getElementById('new_daily_limit').value);
        formData.append('cpm_rate', document.getElementById('new_cpm_rate').value);
        formData.append('file', document.getElementById('new_file').files[0]);

        try {
            const res = await fetch(`${API_BASE}/ads/create`, {
                method: 'POST',
                headers: { 'X-Admin-Token': adminToken },
                body: formData
            });

            if (res.ok) {
                alert("Campaign initialization successful");
                document.getElementById('uploadForm').reset();
                loadDashboard();
            } else {
                const error = await res.json();
                alert(`Error: ${error.message || 'Operation failed'}`);
            }
        } catch (err) {
            console.error('Upload error:', err);
            alert('Upload failed - check network connection');
        }
    });

    document.getElementById('bundleForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const bundleData = {
            activePeriod: document.getElementById('pkg_period').value,
            price: parseFloat(document.getElementById('pkg_price').value),
            bandwidth: document.getElementById('pkg_speed').value,
            quota: document.getElementById('pkg_quota').value,
            isVoucherAccepted: document.getElementById('pkg_voucher').checked
        };

        try {
            const res = await fetch(`${API_BASE}/bundles`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-Admin-Token': adminToken
                },
                body: JSON.stringify(bundleData)
            });

            if (res.ok) {
                alert("Package added successfully");
                document.getElementById('bundleForm').reset();
                loadDashboard();
            } else {
                const error = await res.json();
                alert(`Error: ${error.message || 'Failed to add package'}`);
            }
        } catch (err) {
            console.error('Bundle creation error:', err);
            alert('Failed to create package');
        }
    });

    // --- Utility Functions ---
    async function downloadReport() {
        try {
            const res = await fetch(`${API_BASE}/ads/report`, {
                headers: { 'X-Admin-Token': adminToken }
            });
            if (!res.ok) {
                alert('Failed to generate report');
                return;
            }
            const blob = await res.blob();
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `AsherLink_Report_${new Date().toISOString().split('T')[0]}.pdf`;
            a.click();
            window.URL.revokeObjectURL(url);
        } catch (err) {
            console.error('Report download error:', err);
            alert('Failed to download report');
        }
    }

    async function checkSystemHealth() {
        try {
            const res = await fetch(`${API_BASE}/health`, {
                headers: { 'X-Admin-Token': adminToken }
            });
            const health = await res.json();
            alert(`System Status: ${health.status}\nUptime: ${health.uptime}\nDatabase: ${health.database}`);
        } catch (err) {
            console.error('Health check error:', err);
            alert('Health check failed');
        }
    }

    async function createBackup() {
        if (!confirm("Create database backup? This may take a few minutes.")) return;
        try {
            const res = await fetch(`${API_BASE}/backup`, {
                method: 'POST',
                headers: { 'X-Admin-Token': adminToken }
            });
            const result = await res.json();
            alert(`Backup ${result.success ? 'completed' : 'failed'}: ${result.message}`);
        } catch (err) {
            console.error('Backup error:', err);
            alert('Backup failed');
        }
    }

    // Initialize dashboard on load
    document.addEventListener('DOMContentLoaded', function() {
        if (adminToken) {
            showDashboard();
        }
    });
</script>
</body>
</html>
